---
title: "SQL exercise - Task 2"
description: |
  Create basic metadata about your Hobo.
author:
  - name: Mirko MÃ¤licke
    url: https://hyd.iwg.kit.edu/personen_maelicke.php
    affiliation: Karlsruhe Institute for Technology (KIT)
    affiliation_url: https://hyd.iwg.kit.edu
date: "`r Sys.Date()`"
output:  
  html_document:
    number_sections: yes
    toc: yes
    toc_float: yes
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
  radix::radix_article:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install packages if missing
if (!("RPostgreSQL" %in% installed.packages())){
  install.packages("RPostgreSQL")
}
if (!("getPass" %in% installed.packages())){
  install.packages("getPass")
}
if (!("leaflet" %in% installed.packages())){
  install.packages("leaflet")
}
if (!("wellknown" %in% installed.packages())){
  install.packages("wellknown")
}

# load packages
require(RPostgreSQL)
require(getPass)

# establish the connection
drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, host='v45522.1blu.de', port=5432, user=getPass('Provide the user'), 
                 password=getPass('Provide the password'), dbname='datamanagement')
```

## Solution

This task is considered to be finished when the chunk below is producing the output requested in the task description. Change this section and add the neccessary code to produce the output.

```{sql connection=con}
SELECT * FROM overview
```

## See tables in db

```{r}
dbListTables(con)
```


## create overview table

```{sql connection=con}
CREATE TABLE overview(
hobo_id integer,
raw_data integer,
checked_data integer,
hobos_within_2km_2020 integer,
hobos_within_2km integer,
used_in_2020 boolean,
used_in_2018 boolean,
used_in_2017 boolean
)
```

## fill overview

```{sql connection=con}
INSERT INTO overview
SELECT DISTINCT hobo_id AS hobo_id FROM hobos
UNION 
SELECT count(DISTINCT hobo_id) AS raw_data FROM raw_data
UNION
SELECT SUM(amount) FROM 
(SELECT count(DISTINCT hobo_id) AS amount FROM quality_checked
UNION
SELECT count(DISTINCT hobo_id) AS amount FROM quality_checked_2020
) AS checked_data
UNION
SELECT count(st_astext(st_buffer(st_transform(geom, 25832), 2000))) AS hobos_within_2km_2020
FROM hobos WHERE year = 2020
UNION
SELECT count(st_astext(st_buffer(st_transform(geom, 25832), 2000))) AS hobos_within_2km
FROM hobos
UNION
SELECT year = 2020 IS TRUE AS used_in_2020 FROM hobos
UNION
SELECT year = 2018 IS TRUE AS used_in_2018 FROM hobos
UNION
SELECT year = 2017 IS TRUE AS used_in_2017 FROM hobos
```

## count of no raw data 

```{sql connection=con}
SELECT t2.hobo_id, count(*) AS raw_data
FROM 
  raw_data t1
LEFT JOIN 
  (SELECT id, hobo_id FROM hobo) t2
ON  t1.hobo_id = t2.id
GROUP BY t2.hobo_id 
-- SELECT hobo_id, count(*) AS raw_data from raw_data group by hobo_id
```

## count no of quality checked data
```{sql connection=con}
SELECT hobo_id, count(*) AS checked_data FROM quality_checked GROUP BY hobo_id ORDER BY hobo_id ASC
```

## hobos within 2km radius query in 2020
```{sql connection=con}
select a.id, count(b.hobo_id) as km
from 
    hobos a, hobos b 
where st_dwithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) and a.hobo_id != b.hobo_id and b.year = 2020 and a. year = 2020
group by a.id order by id desc

```

## hobos within 2km radius query

```{sql connection=con}
SELECT a.hobo_id, count(b.hobo_id) AS within
FROM 
    (SELECT hobo_id, st_union(geom) AS geom FROM hobo GROUP BY hobo_id) a,
    (SELECT hobo_id, st_union(geom) AS geom FROM hobo GROUP BY hobo_id) b 
WHERE st_dwithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) AND a.hobo_id != b.hobo_id 
GROUP BY a.hobo_id 
ORDER BY hobo_id DESC
```
```{sql connection = con}

SELECT a.hobo_id, b.hobo_id AS b_id, st_asewkt(b.geom) AS geom
FROM 
    (SELECT hobo_id, st_union(geom) AS geom FROM hobo GROUP BY hobo_id) a,
    (SELECT hobo_id, geom AS geom FROM hobo) b 
WHERE st_dwithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) AND a.hobo_id = 10350083
ORDER BY b_id DESC

```



```{sql connection = con}

select *
from 
    hobos a, hobos b 
where st_dwithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) and a.hobo_id != b.hobo_id 

```
## union geometries of hobo devices
```{sql connection = con}
SELECT hobo_id, st_astext(st_union(geom)) AS geom FROM hobo GROUP BY hobo_id
```



## used in year

```{sql connection=con}
SELECT year = 2020 IS TRUE AS used_in_2020,  year = 2018 IS TRUE AS used_in_2018, year = 2017 IS TRUE AS used_in_2017 FROM hobos
```
## first try to join
```{sql connection=con}
SELECT distinct a.id, count(distinct r.*), count(distinct b.id) as km2, count(distinct c.id) as km2_2020,a.year=2020 is TRUE as year_2020, a.year=2019 is TRUE as year_2019
FROM hobos a
left JOIN hobos b ON ST_DWithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) and a.id!=b.id
	
left JOIN hobos c ON ST_DWithin(st_transform(a.geom, 25832), st_transform(c.geom, 25832), 2000) and a.year =2020 and c.year =2020 and a.id!=c.id
left join raw_data r on r.hobo_id = a.id
 

  
group by a.id order by km2 desc

```

## second try to join
```{sql connection = con}
select hobo_id as HOBO_id, raw_data, km as hobos_within_2km, km_2020 hobos_within_2km_2020
FROM 
  (SELECT hobo_id, count(*) AS raw_data from raw_data group by hobo_id) t1
left JOIN
  (select a.id as id_first, count(b.hobo_id) as km 
    from hobos a, hobos b 
    where st_dwithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) and a.hobo_id != b.hobo_id 
    group by a.id) t2 
on (t1.hobo_id = t2.id_first)
left join 
  (select a.id as id_second, count(b.hobo_id) as km_2020
    from 
    hobos a, hobos b 
    where st_dwithin(st_transform(a.geom, 25832), st_transform(b.geom, 25832), 2000) 
    and a.hobo_id != b.hobo_id and b.year = 2020 and a. year = 2020
    group by a.id) t3
on (t3.id_second = t2.id_first)

order by hobo_id desc
```

## Hints

The follwoing chunks might help you to get started.

If you are dealing with PostGIS, it's often easier to select the HOBOs with human readable locations, as well.
This can be done like:
```{sql connection=con}
SELECT 
  id, 
  hobo_id,
  st_asewkt(geom) as "WKT",
  geom 
FROM hobos

```

Then, you can chain different spatial operations to implement a GIS workflow. To get the distance to a specific point we need to
transform the coordinates and then calculate the distance to that point. First the transform:
```{sql connection=con}
SELECT 
  id, 
  hobo_id,
  st_asewkt(st_transform(geom, 25832)) as "WKT",
  st_transform(geom, 25832) as "geom"
FROM hobos
```

A distance can be calculated like:
```{sql connection=con}
select st_distance(st_geomfromtext('POINT (0 0)'), st_geomfromtext('POINT (1 1)'))
```

You can calculate a 1km buffer around a hobo like:
```{sql connection=con}
SELECT 
  hobo_id,
  st_astext(st_buffer(st_transform(geom, 25832), 1000)) as "Buffer"
FROM hobos
```

We can also transform that back to the reference system used in leaflet and export as WKT. To do so, you need to group all
HOBOs into a single GeometryCollection or MultiPolygon.
```{sql connection=con, output.var="hobos"}
SELECT 
  st_astext(geom) as "Buffered" FROM 
(SELECT 
 1 as op, st_collect(st_transform(st_buffer(st_transform(geom, 25832), 1000), 4326)) as geom
FROM hobos group by op) t

```

```{r}
library(wellknown)

wktview(hobos$Buffered, center=c(7.8, 48), zoom=11)
```

