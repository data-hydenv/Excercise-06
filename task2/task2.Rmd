---
title: "SQL exercise - Task 2"
description: |
  Create basic metadata about your Hobo.
author:
  - name: Mirko MÃ¤licke
    url: https://hyd.iwg.kit.edu/personen_maelicke.php
    affiliation: Karlsruhe Institute for Technology (KIT)
    affiliation_url: https://hyd.iwg.kit.edu
date: "`r Sys.Date()`"
output:  
  html_document:
    number_sections: yes
    toc: yes
    toc_float: yes
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
  radix::radix_article:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# install packages if missing
if (!("RPostgreSQL" %in% installed.packages())){
  install.packages("RPostgreSQL")
}
if (!("getPass" %in% installed.packages())){
  install.packages("getPass")
}
if (!("leaflet" %in% installed.packages())){
  install.packages("leaflet")
}
if (!("wellknown" %in% installed.packages())){
  install.packages("wellknown")
}

# load packages
require(RPostgreSQL)
require(getPass)

# establish the connection
drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, host='v45522.1blu.de', port=5432, user=getPass('Provide the user'), 
                 password=getPass('Provide the password'), dbname='datamanagement')
```

## Solution

This task is considered to be finished when the chunk below is producing the output requested in the task description. Change this section and add the neccessary code to produce the output.

```{sql connection=con}
SELECT * FROM overview
```

## See tables in db

```{r}
dbListTables(con)
```


## create overview table

```{sql connection=con}
CREATE TABLE overview(
hobo_id integer,
raw_data integer,
checked_data integer,
hobos_within_2km_2020 integer,
hobos_within_2km integer,
used_in_2020 boolean,
used_in_2018 boolean,
used_in_2017 boolean
)
```

## fill overview

```{sql connection=con}
INSERT INTO overview
SELECT DISTINCT hobo_id AS hobo_id FROM hobos
UNION 
SELECT count(DISTINCT hobo_id) AS raw_data FROM raw_data
UNION
SELECT SUM(amount) FROM 
(SELECT count(DISTINCT hobo_id) AS amount FROM quality_checked
UNION
SELECT count(DISTINCT hobo_id) AS amount FROM quality_checked_2020
) AS checked_data
UNION
SELECT count(st_astext(st_buffer(st_transform(geom, 25832), 2000))) AS hobos_within_2km_2020
FROM hobos WHERE year = 2020
UNION
SELECT count(st_astext(st_buffer(st_transform(geom, 25832), 2000))) AS hobos_within_2km
FROM hobos
UNION
SELECT year = 2020 IS TRUE AS used_in_2020 FROM hobos
UNION
SELECT year = 2018 IS TRUE AS used_in_2018 FROM hobos
UNION
SELECT year = 2017 IS TRUE AS used_in_2017 FROM hobos
```

## count of no raw data 

```{sql connection=con}

SELECT count(DISTINCT hobo_id) AS amount FROM raw_data
```

## count no of quality checked data
```{sql connection=con}
SELECT SUM(amount) FROM 
(SELECT count(DISTINCT hobo_id) AS amount FROM quality_checked
UNION ALL
SELECT count(DISTINCT hobo_id) AS amount FROM quality_checked_2020
) AS res
```

## hobos within 2km radius query in 2020

```{sql connection=con}
SELECT count(st_astext(st_buffer(st_transform(geom, 25832), 2000))) as hobos_within_2km_2020
FROM hobos WHERE year = 2020
```

## hobos within 2km radius query

```{sql connection=con}
SELECT count(st_astext(st_buffer(st_transform(geom, 25832), 2000))) as hobos_within_2km
FROM hobos
```

## used in year

```{sql connection=con}
SELECT year = 2020 IS TRUE AS used_in_2020,  year = 2018 IS TRUE AS used_in_2018, year = 2017 IS TRUE AS used_in_2017 FROM hobos
```

## Hints

The follwoing chunks might help you to get started.

If you are dealing with PostGIS, it's often easier to select the HOBOs with human readable locations, as well.
This can be done like:
```{sql connection=con}
SELECT 
  id, 
  hobo_id,
  st_asewkt(geom) as "WKT",
  geom 
FROM hobos

```

Then, you can chain different spatial operations to implement a GIS workflow. To get the distance to a specific point we need to
transform the coordinates and then calculate the distance to that point. First the transform:
```{sql connection=con}
SELECT 
  id, 
  hobo_id,
  st_asewkt(st_transform(geom, 25832)) as "WKT",
  st_transform(geom, 25832) as "geom"
FROM hobos
```

A distance can be calculated like:
```{sql connection=con}
select st_distance(st_geomfromtext('POINT (0 0)'), st_geomfromtext('POINT (1 1)'))
```

You can calculate a 1km buffer around a hobo like:
```{sql connection=con}
SELECT 
  hobo_id,
  st_astext(st_buffer(st_transform(geom, 25832), 1000)) as "Buffer"
FROM hobos
```

We can also transform that back to the reference system used in leaflet and export as WKT. To do so, you need to group all
HOBOs into a single GeometryCollection or MultiPolygon.
```{sql connection=con, output.var="hobos"}
SELECT 
  st_astext(geom) as "Buffered" FROM 
(SELECT 
 1 as op, st_collect(st_transform(st_buffer(st_transform(geom, 25832), 1000), 4326)) as geom
FROM hobos group by op) t

```

```{r}
library(wellknown)

wktview(hobos$Buffered, center=c(7.8, 48), zoom=11)
```

