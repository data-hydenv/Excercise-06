---
title: "Exercise6 - Task3"
output: html_document
---

## Load packages
Check if needed packages are installed and loaded.
```{r, echo=FALSE}
if (!("RPostgreSQL" %in% installed.packages())){
  install.packages("RPostgreSQL")
}
if (!("getPass" %in% installed.packages())){
  install.packages("getPass")
}
require(RPostgreSQL)
require(getPass)
```

## Connect to Server
```{r}
drv <- dbDriver('PostgreSQL')
con <- dbConnect(drv, host='v45522.1blu.de', port=5432, user=getPass('Provide the user'), 
                 password=getPass('Provide the password'), dbname='datamanagement')

```
##See available tables
```{r}
dbListTables(con)
```

##Create view on hobos with temperature indices
```{sql connection=con}
CREATE VIEW indices AS
SELECT id, hobo_id, radiation_influence, geom, description, year, srid, created_at, updated_at, mean_day, var_day, perc_90_day, mean_night, var_night, perc_90_night
FROM
  (SELECT hobo_id AS hobo, 
    avg(temperature) AS mean_day,
    variance(temperature) AS var_day,
    percentile_cont(0.9) within GROUP (ORDER BY temperature) AS perc_90_day
    FROM raw_data 
    WHERE date_part('hour', tstamp) >= 6 AND date_part('hour', tstamp) < 18
    GROUP BY hobo_id) AS day
INNER JOIN 
  (SELECT hobo_id AS hobo, 
    avg(temperature) AS mean_night,
    variance(temperature) AS var_night,
    percentile_cont(0.9) within GROUP (ORDER BY temperature) AS perc_90_night
    FROM raw_data 
    WHERE date_part('hour', tstamp) < 6 OR date_part('hour', tstamp) >= 18
    GROUP BY hobo_id) AS night
ON day.hobo=night.hobo
LEFT JOIN hobos
ON hobos.id = night.hobo
```
##Join districts with indices
```{sql connection=con}
SELECT name AS district,
  avg(mean_day) AS mean_day,
  avg(var_day) AS var_day,
  avg(perc_90_day) AS perc_90_day,
  avg(mean_night) AS mean_night,
  avg(var_night) AS var_night,
  avg(perc_90_night) AS perc_90_night
  FROM (SELECT * FROM indices join districts on st_within(indices.geom, districts.geom)) AS test
  GROUP BY name
```

##Make maps

### load data
### indices
```{sql connection=con, output.var ="hobo"}
select id, hobo_id, year, mean_day, var_day, perc_90_day, mean_night, var_night, perc_90_night, st_asewkt(st_transform(geom, 25832)) as "UTM" 
from indices 
```
### freiburg districts
```{sql connection=con, output.var="fr_dis"}
select id, name, st_asewkt(st_transform(geom, 25832)) as "UTM" 
from districts 
```
### freiburg districts indices
```{sql connection=con, output.var = "fr_dis_indi"}
SELECT name,
  avg(mean_day) AS mean_day,
  avg(var_day) AS var_day,
  avg(perc_90_day) AS perc_90_day,
  avg(mean_night) AS mean_night,
  avg(var_night) AS var_night,
  avg(perc_90_night) AS perc_90_night
  FROM (SELECT * FROM indices join districts on st_within(indices.geom, districts.geom)) AS test
  GROUP BY name
```
### creat sf objects
```{r}
library(tmap)
library(sf)
#hobo <- dbReadTable(con, 'indices')
#fr_dis <- dbReadTable(con, 'districts')
fr_dis_indi <- left_join(fr_dis_indi, fr_dis, by = c("name"))
fr_dis_indi_sf <- st_as_sf(fr_dis_indi, wkt = "UTM.x")
hobo_sf <- st_as_sf(hobo, wkt = "UTM")
fr_dis_sf <- st_as_sf(fr_dis, wkt = "UTM")
```

### mean day
```{r}
tm_shape(fr_dis_indi_sf) +
  tm_fill("mean_day", style = "jenks", title = "District") +
  tm_borders() +
    tm_text("name", just = "top") +
tm_shape(hobo_inter) +
  tm_dots(col = "mean_day", shape = 21, size = 0.4, style = "jenks", 
          title = "HOBO") +
  tm_layout(title = "mean day")
   
```
##Selected indice
As the average day temperature is the most intuitive parameter, it was chosen for visualisation. It creates a good overview over the spatial distribution. However, there are several uncertainties influencing the average day temperature, like the exposition, shielding etc. Therefore, a combination of mean, variance and 90th percentile would show a more complete picture.

##Does the spatial aggregation to districts change the overall picture?
The overall picture is definitely changed by the spatial aggregation. The amount of hobos per district varies as well as the area of the different districts. Especially in large suburban district with few hobos, one outlier can dominate a large area. On the other hand, a lot of measurements took place in smaller districts in the city center, which might therefore be more reliable but only represent a small area.

### mean night
```{r}
tm_shape(fr_dis_indi_sf) +
  tm_fill("mean_night", style = "jenks", title = "District") +
  tm_borders() +
    tm_text("name", just = "top") +
tm_shape(hobo_inter) +
  tm_dots(col = "mean_night", shape = 21, size = 0.4, style = "jenks", 
          title = "HOBO") +
  tm_layout(title = "mean night")
   
```

### var day
```{r}
tm_shape(fr_dis_indi_sf) +
  tm_fill("var_day", style = "jenks", title = "District") +
  tm_borders() +
    tm_text("name", just = "top") +
tm_shape(hobo_inter) +
  tm_dots(col = "var_day", shape = 21, size = 0.4, style = "jenks", 
          title = "HOBO") +
  tm_layout(title = "variance day")
   
```

### var night
```{r}
tm_shape(fr_dis_indi_sf) +
  tm_fill("var_night", style = "jenks", title = "District") +
  tm_borders() +
    tm_text("name", just = "top") +
tm_shape(hobo_inter) +
  tm_dots(col = "var_night", shape = 21, size = 0.4, style = "jenks", 
          title = "HOBO") +
  tm_layout(title = "variance night")
   
```

### perc_90 night
```{r}
tm_shape(fr_dis_indi_sf) +
  tm_fill("perc_90_night", style = "jenks", title = "District") +
  tm_borders() +
    tm_text("name", just = "top") +
tm_shape(hobo_inter) +
  tm_dots(col = "perc_90_night", shape = 21, size = 0.4, style = "jenks", 
          title = "HOBO") +
  tm_layout(title = "Perc 90 night")
   
```

### perc_90 day
```{r}
tm_shape(fr_dis_indi_sf) +
  tm_fill("perc_90_day", style = "jenks", title = "District") +
  tm_borders() +
    tm_text("name", just = "top") +
tm_shape(hobo_inter) +
  tm_dots(col = "perc_90_day", shape = 21, size = 0.4, style = "jenks", 
          title = "HOBO") +
  tm_layout(title = "Perc 90 day")
   
```
